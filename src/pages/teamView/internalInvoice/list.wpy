<style lang="less">
@import "../../../style/home.less";
</style>
<template>
	<view class="home-view">
		<view class="home-view-header"></view>
		<view class="page_margin page">
			<scroll-view scroll-y="true" style="height:100%" @scrolltolower="searchScrollLower">
				<view class="home-view-box">
					<search @searchValue="searchValue" class="weui-cell weui-flex start page_card"></search>
					<invoiceList :list.sync="newList" :recommendType.sync="recommendType" @handleJob="handleJob" @selectJob="selectJob">
					</invoiceList>
				</view>
			</scroll-view>
		</view>
  	<viewNoticeModal :isScaleModal.sync="isModal" :height.sync="modalHeight" :timeInfo.sync="timeInfo" :title.sync="title"></viewNoticeModal>
	</view>
</template>
<script>
import wepy from 'wepy'
import { $http } from '@/http.js'
import search from '@/components/search'
import invoiceList from '@/components/invoiceList'
import viewNoticeModal from '@/components/viewNoticeModal'
import { getList, wxNavigateTo, wxShowModal, wxToast, wxReLaunch, wxRedirectTo } from '@/util'
export default class checkResumeList extends wepy.page {
	components = {
		search: search,
		invoiceList: invoiceList,
		viewNoticeModal: viewNoticeModal
	}
	data = {
		list: [],
		params: {
			uid: '',
			page: 1,
			limit: 10
		},
		count: 0,
		isSeachWidth: false,
		isModal: true,
		modalHeight: 860,
		title: '查看面试时间',
		recommendType: 0,
		job_id: '',
		timeInfo: {},
		id: '',
		recommendId: ''
	}
	computed = {
		newList() {
			return getList(this.list, 'addtime')
		},
		urlApi() {
			return this.recommendType ? '/apply/add_put' :'/teamjob/add_put'
		},
		listUrlApi() {
			return this.recommendType==1 ? '/Wxresume/reportOrderList' :'/Wxresume/internalInvoiceList'
		}
	}
	onLoad(options) {
		this.params.uid = wx.getStorageSync('rendaUid') || this.$parent.globalData.uid
		this.recommendType = Number(options.query)
		this.recommendId = options.recommendId
		this.id = options.resumeId
		this.$apply()
		wx.setNavigationBarTitle({
			title: this.getTitle(this.recommendType)
		})
	}
	onShow() {
		this.getList()
	}
	events = {
		searchValue: val => {
			this.params = Object.assign(this.params, { where: val })
			this.getList()
		},
		inputFocus: () => {
			this.isSeachWidth = true
			this.$apply()
		},
		handleJob: data => {
			let params = {}
			if (this.recommendType) {
				params = {
					uid: this.params.uid,
					resume_id: this.id,
					apply_id: data.id
				}
			} else {
				params = {
					uid: this.params.uid,
					resume_id: this.id,
					job_id: data.id
				}
			}
			wxShowModal('', '确定推荐岗位吗?', '确定').then(res => {
				this.recommend(params)
			}).catch(() => {
				console.log('取消')
			})
		},
		selectJob: val =>{
			let url = ''
			if (!this.recommendType) {
				url = 'insiderJobDetail'
			} else {
				wx.setStorageSync('receiptType',-1)
				url = 'teamJobDetail'		
			}
			wxRedirectTo(`/pages/teamView/internalInvoice/${url}?query=${val.id}&resume_id=${this.id}`)
		}
	}
	recommend(params) {
    $http(this.urlApi, params).then(res => {
      if (res.data) {
				wxToast(res.data || '推荐成功')
				wxNavigateTo('/pages/home/index')
			} else {
				wxToast('推荐失败')
			}
    })
  }
	getList() {
		$http(this.listUrlApi, this.params).then(res => {
			this.list = res.data.data || []
			this.count = res.data.count
			this.$apply()
		})
	}
	getTitle(val) {
		return val == 1 ? '团队接单' : '内部发单'
	}
	methods = {
	 searchScrollLower () {
			if (this.count > this.list.length && this.count > this.params.limit) {
				this.params.limit = this.params.limit + 10
				this.getList()
			}
    }
	}
}
</script>